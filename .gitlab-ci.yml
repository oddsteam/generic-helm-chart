stages:
  - build
  - test

variables:
  CHART_NAME: "application"
  KUBECONFIG: "$CI_PROJECT_DIR/.kubeconfig.yaml"

before_script:
  - export KUBECONFIG=$KUBECONFIG

build:
  stage: build
  script:
    - |
        # Set up Helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm version --short

        # Lint
        helm lint ${CHART_NAME}
        helm lint ${CHART_NAME} -f ${CHART_NAME}/values-test.yaml

unittest:
  stage: test
  script:
    - |
        # Set up Helm
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
        helm version --short

        # Install helm-unittest
        helm plugin install https://github.com/quintush/helm-unittest --version v0.5.0

        # Run Helm Unit Tests
        helm unittest ${CHART_NAME}
